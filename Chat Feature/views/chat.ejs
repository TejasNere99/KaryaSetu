<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h2>Chat Room (User <%= convo.userId %> & Worker <%= convo.workerId %>)</h2>

  <div id="messages" style="border:1px solid #ccc; height:250px; overflow-y:auto; padding:5px;"></div>

  <form id="chatForm">
    <input type="text" id="msg" autocomplete="off" placeholder="Type message..." />
    <button type="submit">Send</button>
  </form>

  <script>
    const socket = io();

    const userId = "<%= convo.userId %>";
    const workerId = "<%= convo.workerId %>";
    const sender = "<%= sender %>"; // dynamic user/worker

    // Room join
    socket.emit("joinRoom", { userId, workerId });

    // Purane messages load karo
    socket.on("loadMessages", (messages) => {
      const msgDiv = document.getElementById("messages");
      msgDiv.innerHTML = "";
      messages.forEach(m => {
        msgDiv.innerHTML += `<p><b>${m.sender}:</b> ${m.text} <i>${m.time}</i></p>`;
      });
      msgDiv.scrollTop = msgDiv.scrollHeight;
    });

    // Naya message suno
    socket.on("message", (msg) => {
      const msgDiv = document.getElementById("messages");
      msgDiv.innerHTML += `<p><b>${msg.sender}:</b> ${msg.text} <i>${msg.time}</i></p>`;
      msgDiv.scrollTop = msgDiv.scrollHeight;
    });

    // Form se bhejo
    document.getElementById("chatForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const text = document.getElementById("msg").value;
      if (!text) return;
      socket.emit("chatMessage", { userId, workerId, sender, text });
      document.getElementById("msg").value = "";
    });
  </script>
</body>
</html>
