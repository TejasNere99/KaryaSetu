<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= category %> - Workers
  </title>
  <link rel="stylesheet" href="/category.css">
</head>

<body>
  <a href="https://karyasetu.onrender.com/"
          class="btn-back">
          ‚Üê Back
  </a>
  <h1>
    <%= category %> Workers
  </h1>
  <div class="worker-grid">
    <% if(workers.length===0){ %>
      <p>No workers available in this category yet.</p>
      <% } else { %>
        <% workers.forEach(w=> { %>
          <div class="card">
            <div class="card-image">
              <% if(w.img && w.img !=="" ){ %>
                <img src="<%= w.img %>" alt="<%= w.name %>">
                <% } else { %>
                  <div class="default-icon">üë∑</div>
                  <% } %>
            </div>
            <div class="card-content">
              <h3>
                <%= w.name %>
              </h3>
              <p class="subcategory">
                <%= w.subcategory %>
              </p>
              <p><strong>Age:</strong>
                <%= w.age %>
              </p>
              <p><strong>Experience:</strong>
                <%= w.experience %> years
              </p>
              <p><strong>Address:</strong>
                <%= w.address %>
              </p>
            </div>
            <div class="action-buttons">
              <form action="/send-request/<%=w.id%>">
                <button class="hire-btn send-request-btn" data-worker-id="<%= w.id %>">Send Request</button>
              </form>
              <form class="message-form" method="get">
                <button type="submit" class="hire-btn message-me-btn" data-worker-id="<%= w.id %>">
                  Message Me
                </button>
              </form>
            </div>
          </div>
          <% }) %>
            <% } %>
  </div>
  <script>
  // Check login status
  let userId = null;
  try {
    userId = parseInt(localStorage.getItem('userId'));
  } catch (e) {
    console.error("Error getting userId:", e);
  }

  const messageForms = document.querySelectorAll('.message-form');

  messageForms.forEach(form => {
    const workerId = form.querySelector('.message-me-btn').getAttribute('data-worker-id');

    // If logged in ‚Üí set chat route
    if (userId) {
      form.setAttribute('action', `/chat/${userId}/${workerId}/user`);
    } 
    // If not logged in ‚Üí show alert and redirect
    else {
      form.addEventListener('submit', (e) => {
        e.preventDefault(); // stop form submit
        alert("‚ö†Ô∏è Please login to continue");
        window.location.href = "/mainLogin.html";
      });
    }
  });
</script>

</body>

</html>
